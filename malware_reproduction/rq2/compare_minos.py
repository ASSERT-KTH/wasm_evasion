import os
import sys
import re
# import pandas as pd
import zipfile
import shutil
import minos
import time

CURRENT_DIR = os.path.dirname(__file__)
FOLDER = "mc_finalcomplete2"

if __name__ == "__main__":
    t = time.time()
    model = minos.MINOS()
    model.fit(model_name=f"{CURRENT_DIR}/original23.h5")
    print("Time loading", time.time() - t)
    t = time.time()


    for binary in os.listdir(os.path.join(CURRENT_DIR, FOLDER)):
        if "DS_Store" not in binary:
            # Check for generated binaries
            ini = "count/reward_5"

            betas = ["0.01", "0.3", "1.1"]
            for b in betas:
            # get zip __file__
                zipf = os.path.join(
                    CURRENT_DIR,
                    FOLDER,
                    binary,
                    ini,
                    b,
                    "out.zip"
                )
                print(zipf)
                if os.path.exists(zipf):
                    with zipfile.ZipFile(zipf) as z:
                        for f in z.filelist:
                            if "variant.wasm" in f.filename:
                                if "/interesting/" in f.filename:
                                    # get the bytes of the variant.wasm
                                    wfolder = f"{CURRENT_DIR}/out/{binary}/{b}"
                                    try:
                                        os.makedirs(wfolder)
                                    except:
                                        pass

                                    bts = z.read(f)
                                    open(f"{wfolder}/variant.wasm", 'wb').write(bts)
                                    pixels = minos.preprocess_csv(f"{wfolder}/variant.wasm")
                                    print("Time preprocess", time.time() - t)
                                    predictions = model.predict(pixels)
                                    print(predictions)
                                    if int(predictions['BENIGN'].values[-1]) > 0.9:
                                        print(binary, b, "breaks minos")
                                        shutil.move(f"{wfolder}/variant.wasm", f"{wfolder}/breakminos.wasm")




                                    print(f)




