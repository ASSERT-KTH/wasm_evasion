apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: obfuscator-collect-metadata-filtered-
spec:
  entrypoint: obfuscator-distributed
  parallelism: 8
  arguments:
    parameters:
    - name: dbconn
    - name: dbpass
    - name: dbuser
    - name: collection
  templates:
  - name: obfuscator-distributed
    steps:
    - - name: execute-analyzer
        template: analyzer-template
        arguments:
          parameters:
          - name: folder
            value: "{{item.folder}}"
          - name: url
            value: "{{item.url}}"
          - name: path
            value: "{{item.path}}"
        withItems:
          
          
          - { folder: filtered1, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered1.zip, path: filtered1/filtered-binaries-metadata/filtered1 }
          - { folder: filtered2, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered2.zip, path: filtered2/filtered-binaries-metadata/filtered2 }
          - { folder: filtered3, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered3.zip, path: filtered3/filtered-binaries-metadata/filtered3 }
          - { folder: filtered4, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered4.zip, path: filtered4/filtered-binaries-metadata/filtered4 }
          - { folder: filtered5, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered5.zip, path: filtered5/filtered-binaries-metadata/filtered5 }
          - { folder: filtered6, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered6.zip, path: filtered6/filtered-binaries-metadata/filtered6 }
          - { folder: filtered7, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered7.zip, path: filtered7/filtered-binaries-metadata/filtered7 }
          - { folder: filtered8, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered8.zip, path: filtered8/filtered-binaries-metadata/filtered8 }
          - { folder: filtered9, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered9.zip, path: filtered9/filtered-binaries-metadata/filtered9 }
          - { folder: filtered10, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered10.zip, path: filtered10/filtered-binaries-metadata/filtered10 }
          - { folder: filtered11, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered11.zip, path: filtered11/filtered-binaries-metadata/filtered11 }
          - { folder: filtered12, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered12.zip, path: filtered12/filtered-binaries-metadata/filtered12 }
          - { folder: filtered13, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered13.zip, path: filtered13/filtered-binaries-metadata/filtered13 }
          - { folder: filtered14, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered14.zip, path: filtered14/filtered-binaries-metadata/filtered14 }
          - { folder: filtered15, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered15.zip, path: filtered15/filtered-binaries-metadata/filtered15 }
          - { folder: filtered16, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered16.zip, path: filtered16/filtered-binaries-metadata/filtered16 }
          - { folder: filtered17, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered17.zip, path: filtered17/filtered-binaries-metadata/filtered17 }
          - { folder: filtered18, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered18.zip, path: filtered18/filtered-binaries-metadata/filtered18 }
          - { folder: filtered19, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered19.zip, path: filtered19/filtered-binaries-metadata/filtered19 }
          - { folder: filtered20, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered20.zip, path: filtered20/filtered-binaries-metadata/filtered20 }
          - { folder: filtered21, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered21.zip, path: filtered21/filtered-binaries-metadata/filtered21 }
          - { folder: filtered22, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered22.zip, path: filtered22/filtered-binaries-metadata/filtered22 }
          - { folder: filtered23, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered23.zip, path: filtered23/filtered-binaries-metadata/filtered23 }
          - { folder: filtered24, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered24.zip, path: filtered24/filtered-binaries-metadata/filtered24 }
          - { folder: filtered25, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered25.zip, path: filtered25/filtered-binaries-metadata/filtered25 }
          - { folder: filtered26, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered26.zip, path: filtered26/filtered-binaries-metadata/filtered26 }
          - { folder: filtered27, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered27.zip, path: filtered27/filtered-binaries-metadata/filtered27 }
          - { folder: filtered28, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered28.zip, path: filtered28/filtered-binaries-metadata/filtered28 }
          - { folder: filtered29, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered29.zip, path: filtered29/filtered-binaries-metadata/filtered29 }
          - { folder: filtered30, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered30.zip, path: filtered30/filtered-binaries-metadata/filtered30 }
          - { folder: filtered31, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered31.zip, path: filtered31/filtered-binaries-metadata/filtered31 }
          - { folder: filtered32, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered32.zip, path: filtered32/filtered-binaries-metadata/filtered32 }
          - { folder: filtered33, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered33.zip, path: filtered33/filtered-binaries-metadata/filtered33 }
          - { folder: filtered34, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered34.zip, path: filtered34/filtered-binaries-metadata/filtered34 }
          - { folder: filtered35, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered35.zip, path: filtered35/filtered-binaries-metadata/filtered35 }
          - { folder: filtered36, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered36.zip, path: filtered36/filtered-binaries-metadata/filtered36 }
          - { folder: filtered37, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered37.zip, path: filtered37/filtered-binaries-metadata/filtered37 }
          - { folder: filtered38, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered38.zip, path: filtered38/filtered-binaries-metadata/filtered38 }
          - { folder: filtered39, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered39.zip, path: filtered39/filtered-binaries-metadata/filtered39 }
          - { folder: filtered40, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered40.zip, path: filtered40/filtered-binaries-metadata/filtered40 }
          - { folder: filtered41, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered41.zip, path: filtered41/filtered-binaries-metadata/filtered41 }
          - { folder: filtered42, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered42.zip, path: filtered42/filtered-binaries-metadata/filtered42 }
          - { folder: filtered43, url: https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/filtered43.zip, path: filtered43/filtered-binaries-metadata/filtered43 }
          
        continueOn:
          failed: true
    - - name: collect-metas
        template: collect-metas-template
  - name: collect-metas-template
    inputs:
      artifacts:
      - name: metas
        path: /tmp/
        s3:
          bucket: my-bucket
          endpoint: minio-service.minio:3434
          insecure: true
          key: "my-artifacts\
            /{{workflow.creationTimestamp.Y}}\
            /{{workflow.creationTimestamp.m}}\
            /{{workflow.creationTimestamp.d}}\
            /{{workflow.name}}"
          accessKeySecret:
            name: argo-artifacts
            key: accesskey
          secretKeySecret:
            name: argo-artifacts
            key: secretkey
    outputs:
      artifacts:
        - name: all-metas
          path: /all
          archive:
            none: {}
    script:
      image: ubuntu:20.04
      command: [bash]
      source: |
        mkdir /all
        find /tmp -type f -exec bash -c "cp --backup=t {} /all/" \;
  - name: analyzer-template
    inputs:
      parameters:
      - name: url
      - name: folder
      - name: path
    outputs:
      artifacts:
      - name: metas
        path: /metas
        archive:
          none: {}
      - name: reduced
        path: /reduced
        archive:
          none: {}
    script:
      image: ubuntu:20.04
      command: [bash]
      source: |
         mkdir -p reduced
         mkdir -p metas

         apt-get update
         apt-get install -y wget curl unzip
         wget https://github.com/Jacarte/obfuscation_wasm/releases/download/analyzer/analyzer
         echo "======="
         echo "======="

         ls analyzer 
         chmod +x analyzer
         
         wget -O {{inputs.parameters.folder}}.zip {{inputs.parameters.url}}
         echo "======="
         echo "======="
         ls .

         unzip {{inputs.parameters.folder}}.zip -d {{inputs.parameters.folder}}
         
         ./analyzer  "{{workflow.parameters.dbpass}}" "{{workflow.parameters.dbuser}}" --collection_name filtered_{{workflow.parameters.collection}}d1 --dbconn "{{workflow.parameters.dbconn}}" extract -d 1 -m muts_d1  "{{inputs.parameters.path}}" || true

